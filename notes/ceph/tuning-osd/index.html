<!DOCTYPE html>
<html><head>
  <title>
      
          Tuning OSD - henyxia&#39;s website
      
  </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Jean Wasilewski" />
  <link rel="shortcut icon" type="image/x-icon" href="https://henyxia.github.io/img/favicon.ico">

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

  <meta property="og:title" content="Tuning OSD" />
<meta property="og:description" content="My OSD are getting OOM killed Sometimes, Ceph OSD use way more memory than expected. Most of the time, the thumb rule to apply is 1To of storage being equal to 1Go of memory. In some cases, like recovery or scrubbing, the rule does not work, resulting in a OOM kill in a memory restrained environment.
When using bluestore, it is possible to reduce the memory used by OSD by tuning some particular settings through the admin socket of the OSD." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://henyxia.github.io/notes/ceph/tuning-osd/" />

<meta itemprop="name" content="Tuning OSD">
<meta itemprop="description" content="My OSD are getting OOM killed Sometimes, Ceph OSD use way more memory than expected. Most of the time, the thumb rule to apply is 1To of storage being equal to 1Go of memory. In some cases, like recovery or scrubbing, the rule does not work, resulting in a OOM kill in a memory restrained environment.
When using bluestore, it is possible to reduce the memory used by OSD by tuning some particular settings through the admin socket of the OSD.">



<meta itemprop="wordCount" content="249">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tuning OSD"/>
<meta name="twitter:description" content="My OSD are getting OOM killed Sometimes, Ceph OSD use way more memory than expected. Most of the time, the thumb rule to apply is 1To of storage being equal to 1Go of memory. In some cases, like recovery or scrubbing, the rule does not work, resulting in a OOM kill in a memory restrained environment.
When using bluestore, it is possible to reduce the memory used by OSD by tuning some particular settings through the admin socket of the OSD."/>

  <!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->

  <!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <![endif]-->

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146517157-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</head>
<body><nav class="navbar is-transparent is-fixed-top is-info">
  <div class="navbar-brand">
  <a class="navbar-item" href="https://henyxia.github.io/notes">
      NOTES>
    </a>
    <div class="navbar-burger burger" data-target="navbarExampleTransparentExample">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div id="navbarExampleTransparentExample" class="navbar-menu">
    <div class="navbar-start">
      <div class="navbar-item" href="https://bulma.io/">
        Tuning OSD
      </div>
    </div>
  </div>
</nav>


<br />
<br />
<br />
<br />

<div class="tile is-ancestor">
  <div class="tile is-vertical is-2">
    <div class="tile">
      <div class="tile is-parent">
        <article class="tile is-child notification"><aside class="menu">
  <p class="menu-label">
    Menu
  </p>



<ul class="menu-list">
  
  
    
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/projects/">Projects</a>
        
      </li>
    
  

  
    
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/">Scholar</a>
        
        <ul class="sub-menu">
          
            
  
  
    
      <li class="">
        
        <p class="menu-label">GIS4 - 2019</p>
        
        <ul class="sub-menu">
          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/gis4-2019/00-intro/">Presentation</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/gis4-2019/01-reminders/">Reminders</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/gis4-2019/02-network/">Network commands</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/gis4-2019/03-vlan/">VLAN definition</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/gis4-2019/04-cisco/">Cisco presentation</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/scholar/gis4-2019/10-tutorials/">Tutorials</a>
        
      </li>
    
  

          
        </ul>
      </li>
    
  

          
        </ul>
      </li>
    
  

  
    
  
  
    
      <li class="active">
        
        <a href="https://henyxia.github.io/notes/">Notes</a>
        
        <ul class="sub-menu">
          
            
  
  
    
      <li class="active">
        
        <p class="menu-label">Ceph</p>
        
        <ul class="sub-menu">
          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/notes/ceph/create-osd/">Creation</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/notes/ceph/remove-osd/">Deletion</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="active">
        
        <a href="https://henyxia.github.io/notes/ceph/tuning-osd/">Tuning</a>
        
      </li>
    
  

          
        </ul>
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <p class="menu-label">IPMI</p>
        
        <ul class="sub-menu">
          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/notes/ipmi/basics/">Basics</a>
        
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/notes/ipmi/kernel-module/">kernel modules</a>
        
      </li>
    
  

          
        </ul>
      </li>
    
  

          
            
  
  
    
      <li class="">
        
        <a href="https://henyxia.github.io/notes/raid/">Soft RAID</a>
        
      </li>
    
  

          
        </ul>
      </li>
    
  

  
</ul>

</aside>

        </article>
      </div>
    </div>
  </div>
  <div class="tile is-parent">
    <article class="tile is-child notification has-background-grey-light">
      <div class="content">
        <div class="content">
          
	  

<h2 id="my-osd-are-getting-oom-killed">My OSD are getting OOM killed</h2>

<p>Sometimes, Ceph OSD use way more memory than expected. Most of the time, the
thumb rule to apply is 1To of storage being equal to 1Go of memory. In some
cases, like recovery or scrubbing, the rule does not work, resulting in a OOM
kill in a memory restrained environment.</p>

<p>When using bluestore, it is possible to reduce the memory used by OSD by tuning
some particular settings through the admin socket of the OSD. Usually, this
socket can be found in: <code>/var/run/ceph/${CLUSTER}-${OSD_ID}.asok</code>.</p>

<p>To display the current values of the bluestore cache, use:
<code>ceph daemon ${OSD_ADMIN_SOCKET} config show | grep bluestore_cache_size</code></p>

<p>Example:</p>

<pre><code># ceph daemon /var/run/ceph/b1ad1435-8b7f-4689-b334-f4c69a72e50b-osd.2.asok config show | grep bluestore_cache_size
    &quot;bluestore_cache_size&quot;: &quot;0&quot;,
    &quot;bluestore_cache_size_hdd&quot;: &quot;1073741824&quot;,
    &quot;bluestore_cache_size_ssd&quot;: &quot;3221225472&quot;,
</code></pre>

<p>Setting a lesser value for the OSD has been reported to fix most of OOM
issues. For example, run this command to set the cache to 512MB:
<code>ceph daemon ${OSD_ADMIN_SOCKET} config set bluestore_cache_size_hdd 536870912</code></p>

<h2 id="my-osd-is-not-respecting-its-memory-limit">My OSD is not respecting its memory limit</h2>

<p>Even if this issue could be related to an old bug now fixed, Ceph OSDs can
consume more memory than expected. This can be related to Ceph OSD autotune
capacity.</p>

<p>To check current status of the autotune capacity:
<code>ceph daemon ${OSD_ADMIN_SOCKET} config get bluestore_cache_autotune</code></p>

<p>To stop autotune:
<code>ceph daemon ${OSD_ADMIN_SOCKET} config set bluestore_cache_autotune false</code></p>

<h2 id="how-to-diag-osd-memory-usage">How to diag OSD memory usage</h2>

<p><code>ceph daemon ${OSD_ADMIN_SOCKET} dump_mempools</code></p>

<p>With <code>${OSD_ADMIN_SOCKET}</code> being <code>/var/run/ceph/${CLUSTER}-${OSD_ID}.asok</code>.</p>

<hr />

<p>References:</p>

<ul>
<li><a href="http://lists.ceph.com/pipermail/ceph-users-ceph.com/2017-September/020829.html">Ceph ML on cache size</a></li>
<li><a href="http://lists.ceph.com/pipermail/ceph-users-ceph.com/2017-September/020988.html">Ceph ML on memory usage diag</a></li>
<li><a href="http://docs.ceph.com/docs/master/rados/configuration/bluestore-config-ref/">Ceph doc on bluestore_cache_size</a></li>
</ul>

        </div>
      </div>
    </article>
  </div>
</div>

  </body>
</html>
